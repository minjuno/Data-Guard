# Manual Switchover

## Manual Switchover

### 1. Primary db→ Standby로 전환(PROD를 Standby로 전환)

**primary가 read write로 open되어 있어야 한다**

```sql
select open_mode, database_role from v$database;

OPEN_MODE            DATABASE_ROLE
-------------------- ----------------
READ WRITE           PRIMARY
```

**switchover 가능 여부 확인**

```sql
# primary
select switchover_status from v$database;

SWITCHOVER_STATUS
--------------------
TO STANDBY

# SESSIONS ACTIVE인 경우 강제 전환 가능
```

**Primary에서 최종 아카이브 로그 전송**

```sql
alter system archive log current;
alter system switch logfile;
```

**Primary를 Standby로 전환**

```sql
alter database commit to switchover to physical standby;

# 세션이 있는 경우
# alter database commit to switchover to physical standby with session shutdown;
```

**Primary database shutdown 후 mount로 재시작**

```sql
# switchover하면 shutdown 되는 것 같다
shutdown immediate

# 이전 primary db를 standby db로 mount 한다
startup nomount
alter database mount standby database;
alter database recover managed standby database disconnect from session;

# 그냥 startup mount 해도 상관 없는 것 같다
```

### 2. Standby → Primary 전환(SBDB를 Primary로 전환)

**Standby에서 switchover 가능 여부 확인**

```sql
select switchover_status from v$database;

SWITCHOVER_STATUS
--------------------
TO PRIMARY
```

**Standby 복구 모드 취소(실행 중인 경우)**

```sql
alter database recover managed standby database cancel;
```

**Standby를  Primary로 전환**

```sql
alter database commit to switchover to primary;

# 세션이 있는 경우
# alter database commit to switchover to primary with session shutdown;
```

**새로운 Primary db open(SBDB)**

```sql
shutdown immediate

startup

select open_mode, database_role from v$database;

OPEN_MODE            DATABASE_ROLE
-------------------- ----------------
READ WRITE           PRIMARY
```

### 3. 검증

```sql
# SBDB
create tablespace ts05
   datafile '/u01/app/oracle/oradata/SBDB/disk3/ts05.dbf' size 10m;
   
alter system switch logfile;
/
alter system checkpoint;

select name from v$datafile;

NAME
--------------------------------------------------------------------------------
/u01/app/oracle/oradata/SBDB/disk1/system01.dbf
/u01/app/oracle/oradata/SBDB/disk2/sysaux01.dbf
/u01/app/oracle/oradata/SBDB/disk4/undotbs01.dbf
/u01/app/oracle/oradata/SBDB/disk3/ts05.dbf

=================================================================================
# PROD
select name from v$datafile;

NAME
--------------------------------------------------------------------------------
/u01/app/oracle/oradata/PROD/disk1/system01.dbf
/u01/app/oracle/oradata/PROD/disk2/sysaux01.dbf
/u01/app/oracle/oradata/PROD/disk4/undotbs01.dbf
/u01/app/oracle/oradata/PROD/disk3/ts05.dbf
```