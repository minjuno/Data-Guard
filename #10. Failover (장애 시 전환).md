# Failover (장애 시 전환)

### Failover vs Switchover

| 구분 | Failover | Switchover |
| --- | --- | --- |
| **목적** | 긴급 장애 조치 | 계획된 역할 전환 |
| **Primary 상태** | 비정상/불가용 | 정상 가동 |
| **데이터 손실** | 가능 (Protection Mode에 따라) | 없음 |
| **복귀** | Reinstate (재구성) | Switchback |

### Primary db가 사용 불가능할 때 Standby db가 Primary db로 사용될 수 있다.

```sql
# primary 사용 불가 환경 구성
shutdown abort
ORACLE instance shut down
```

## Standby database (SBDB) 접속 후 failover

### Manual

**복구 적용 중지**

```sql
alter database recover managed standby database cancel;
```

**최종 복구**

```sql
# 모든 redo 적용
alter database recover managed standby database finish;

# 강제 완료 (데이터 손실 가능)
alter database recover managed standby database finish force;
```

**Standby를 Primary로 활성화**

```sql
alter database activate standby database;
```

**새로운 Primary로 open**

```sql
alter database open;
```

**역할 확인**

```sql
select database_role, open_mode from v$database;

DATABASE_ROLE    OPEN_MODE
---------------- --------------------
PRIMARY          READ WRITE
```

### **DGMGRL 사용**

```sql
dgmgrl sys/oracle@SBDB 

DGMGRL> failover to SBDB;
Performing failover NOW, please wait...
Failover succeeded, new primary is "SBDB"

DGMGRL> show configuration;

Configuration - dg_config

  Protection Mode: MaxPerformance
  Members:
  sbdb - Primary database
    prod - Physical standby database (disabled)
      ORA-16661: the standby database needs to be reinstated
```

- Standby 데이터베이스를 Primary로 전환 후 새 Primary가 된 데이터베이스는 최신 상태의 redo 정보를 포함하기 때문에 백업을 필수로 수행해야 한다.

### Reinstate

기존의 Primary db는 Standby로 재구성(reinstate)할 수 있다.

Flashback database기능이 Primary db에 활성화되어 있으면 Standby로 쉽게 전환할 수 있다.

```sql
DGMGRL> reinstate database PROD;
Reinstating database "PROD", please wait...
Operation requires shut down of instance "PROD" on database "PROD"
Shutting down instance "PROD"...
ORACLE instance shut down.
Operation requires start up of instance "PROD" on database "PROD"
Starting instance "PROD"...
ORACLE instance started.
Database mounted.
Continuing to reinstate database "PROD" ...
Reinstatement of database "PROD" succeeded
```

Flashback database 기능이 비활성화 되어 있으면, manual 방식으로 PROD를 standby로 재생성 해야한다.

앞에서 Standby Server Setup단계의 작업을 수행한다