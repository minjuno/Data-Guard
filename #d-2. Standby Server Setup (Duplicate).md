# Standby Server Setup (Duplicate)

### 디렉토리 생성

**Standby db에서 디렉토리 생성**

```bash
mkdir /u01/app/oracle/oradata/SBDB

mkdir /home/oracle/SBDB

mkdir -p /home/oracle/SBDB/flash
mkdir -p /home/oracle/SBDB/arch
```

### Standby Server 준비

Standy 쪽에서 nomount 상태로 올리기 위한 최소 파라미터 파일로 인스턴스를 시작한다

```bash
export ORACLE_SID=SBDB

# 임시 파라미터 파일 생성
vi /tmp/initSBDB.ora
-----------------------------------------
db_name='PROD'
db_unique_name='SBDB'
db_create_file_dest='/u01/app/oracle/oradata/SBDB'
db_create_online_log_dest_1='/u01/app/oracle/oradata/SBDB'
db_recovery_file_dest_size=4G
db_recovery_file_dest='/home/oracle/SBDB/flash'
-----------------------------------------

sqlplus / as sysdba

SQL> startup nomount pfile = '/tmp/initSBDB.ora';
```

### **리스너 설정**

**Standby db listener.ora 생성/수정**

```bash
cd $ORACLE_HOME/network/admin
vi listener.ora
------------------------------------------------------------------------

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.13.199)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )
SID_LIST_LISTENER=
  (SID_LIST =
    (SID_DESC =
      (ORACLE_HOME=/u01/app/oracle/product/19.3.0/dbhome_1)
      (SID_NAME=SBDB)
     )
   )
```

**Standby db tnsnames.ora 생성/수정** 

```sql
PROD =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.13.198)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = PROD)
    )
  )

SBDB =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.13.199)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = SBDB)
    )
  )
 
```

**Standby listener 재기동**

```bash
lsnrctl stop
lsnrctl start
```

**Primary -> Standby / Standby -> Primary 접속 확인**

```bash
# primary db
sqlplus sys/oracle@SBDB as sysdba

# standby db
sqlplus sys/oracle@PROD as sysdba
```

### RMAN 접속

Standby 서버에서 RMAN으로 Primary / Standby 모두 접속

```bash
rman target sys/oracle@PROD AUXILIARY sys/oracle@SBDB
```

- OS 인증 (rman target / ) 대신 네트워크 접속을 사용해야 한다
- tnsnames.ora 설정이 되어 있으므로 그대로 사용한다

### Duplicate 실행

```bash
DUPLICATE TARGET DATABASE
  FOR STANDBY
  FROM ACTIVE DATABASE
  DORECOVER
  SPFILE
    SET db_unique_name='SBDB' COMMENT 'Physical Standby for PROD'
    SET db_file_name_convert='/u01/app/oracle/oradata/PROD/','/u01/app/oracle/oradata/SBDB/'
    SET log_file_name_convert='/u01/app/oracle/oradata/PROD/','/u01/app/oracle/oradata/SBDB/'
    SET log_archive_config='dg_config=(PROD,SBDB)'
    SET log_archive_dest_1='LOCATION=/home/oracle/SBDB/arch VALID_FOR=(ALL_LOGFILES,ALL_ROLES) DB_UNIQUE_NAME=SBDB'
    SET log_archive_dest_2='SERVICE=PROD LGWR SYNC AFFIRM VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=PROD'
    SET db_recovery_file_dest_size='4G'
    SET db_recovery_file_dest='/home/oracle/SBDB/flash'
    SET fal_server='PROD'
    SET fal_client='SBDB'
    SET standby_file_management='AUTO'
    SET memory_target='1G'
    SET processes='300'
    SET undo_management='AUTO'
    SET undo_tablespace='UNDOTBS1'
  NOFILENAMECHECK;

```

| 옵션 | 설명 |
| --- | --- |
| **FOR STANDBY** | Standby DB로 복제한다는 뜻. 따라서 DBID를 변경하지 않음 (Primary와 같은 DBID 유지). |
| **FROM ACTIVE DATABASE** | 백업본을 사용하지 않고, Primary DB의 데이터파일을 네트워크를 통해 실시간으로 복제. |
| **DORECOVER** | DUPLICATE 이후 자동으로 복구 → Standby를 즉시 사용 가능 상태로 만든다 |
| **SPFILE** | Primary의 spfile을 복사하면서 일부 파라미터를 SET 명령으로 수정 가능 |
| **SET ...** | Standby에서만 다르게 설정할 파라미터 지정 (예: 파일 경로, 이름, job_queue_processes 등) |
| **NOFILENAMECHECK** | 대상 서버에서 같은 경로의 파일이 있어도 경로 중복 확인을 생략. 주로 서로 다른 서버일 때 사용 |

**결과 확인**

```bash
sqlplus / as sysdba

select name, open_mode, database_role from v$database;

NAME    OPEN_MODE    DATABASE_ROLE
------- ------------ ----------------
SBDB    MOUNTED      PHYSICAL STANDBY
```

### **redo log file 생성**

**Primary db에도 logfile을 똑같이 생성해주어야 한다.**

```sql
export ORACLE_SID=PROD

sqlplus / as sysdba

select status from v$instance;

STATUS
------------
MOUNTED

alter database add standby logfile
   group 10 ('/u01/app/oracle/oradata/PROD/stby_redo10.log') SIZE 100M,
   group 11 ('/u01/app/oracle/oradata/PROD/stby_redo11.log') SIZE 100M,
   group 12 ('/u01/app/oracle/oradata/PROD/stby_redo12.log') SIZE 100M,
   group 13 ('/u01/app/oracle/oradata/PROD/stby_redo13.log') SIZE 100M,
   group 14 ('/u01/app/oracle/oradata/PROD/stby_redo14.log') SIZE 100M,
   group 15 ('/u01/app/oracle/oradata/PROD/stby_redo15.log') SIZE 100M;
```

**Standby db에 똑같이 생성**

```sql
export ORACLE_SID=SBDB

sqlplus / as sysdba

alter database add standby logfile
   group 10 ('/u01/app/oracle/oradata/SBDB/stby_redo10.log') SIZE 100M,
   group 11 ('/u01/app/oracle/oradata/SBDB/stby_redo11.log') SIZE 100M,
   group 12 ('/u01/app/oracle/oradata/SBDB/stby_redo12.log') SIZE 100M,
   group 13 ('/u01/app/oracle/oradata/SBDB/stby_redo13.log') SIZE 100M,
   group 14 ('/u01/app/oracle/oradata/SBDB/stby_redo14.log') SIZE 100M,
   group 15 ('/u01/app/oracle/oradata/SBDB/stby_redo15.log') SIZE 100M; 
```
