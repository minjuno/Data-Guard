# Standby Server Setup(Manual)

### 파일 복제

**Standby db에서 디렉토리 생성**

```bash
mkdir /u01/app/oracle/oradata/SBDB

mkdir /home/oracle/SBDB

cd SBDB
mkdir flash
mkdir arch
```

**primary db에서 datafile, controlfile, redo log file 위치를 확인한다**

```bash
select file_id, tablespace_name, file_name from dba_data_files;
select name from v$controlfile;
select group#, member from v$logfile;
```

**디렉토리, 파일을 primary에서 standby 쪽으로 copy**

```bash
shutdown immediate 

scp -rp /u01/app/oracle/oradata/PROD/* oracle@192.168.13.199:/u01/app/oracle/oradata/SBDB/
```

**패스워드 파일 확인**

standby용 패스워드 파일을 복제 후 copy

```sql
cd $ORACLE_HOME/dbs

cp orapwPROD orapwSBDB

scp orapwSBDB oracle@192.168.13.199:/u01/app/oracle/product/19.3.0/dbhome_1/dbs/
```

**파라미터 파일 확인**

위에서 생성한 Standby용 initSBDB.ora 파일을 복사

```sql
scp initSBDB.ora oracle@192.168.13.199:/u01/app/oracle/product/19.3.0/dbhome_1/dbs/
```

**Primary mount 후 Standby용 controlfile 생성**

```sql
sqlplus / as sysdba

startup mount

alter database create standby controlfile as '$HOME/physical.ctl' reuse;

cd
ls -l physical.*
-rw-r-----. 1 oracle oinstall 8634368 10월  2 19:55 physical.ctl
```

**Primary에서 생성한 Standby용 controlfile을 복사**

```sql
scp $HOME/physical.ctl oracle@192.168.13.199:/u01/app/oracle/oradata/SBDB/disk1/ctrl1.ctl
scp $HOME/physical.ctl oracle@192.168.13.199:/u01/app/oracle/oradata/SBDB/disk2/ctrl2.ctl
scp $HOME/physical.ctl oracle@192.168.13.199:/u01/app/oracle/oradata/SBDB/disk3/ctrl3.ctl
```

### **리스너 설정**

**Standby db listener.ora 생성/수정**

```sql
LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.13.199)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )
SID_LIST_LISTENER=
  (SID_LIST =
    (SID_DESC =
      (ORACLE_HOME=/u01/app/oracle/product/19.3.0/dbhome_1)
      (SID_NAME=SBDB)
     )
   )
```

**Standby db tnsnames.ora 생성/수정** 

```sql
PROD =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.13.198)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = PROD)
    )
  )

SBDB =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.13.199)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = SBDB)
    )
  )
 
```

**Primary -> Standby / Standby -> Primary 접속 확인**

```bash
# primary db
sqlplus sys/oracle@SBDB as sysdba

# standby db
sqlplus sys/oracle@PROD as sysdba
```

### **redo log file 생성**

**Primary db에도 logfile을 똑같이 생성해주어야 한다.**

```sql
export ORACLE_SID=PROD

sqlplus / as sysdba

select status from v$instance;

STATUS
------------
MOUNTED

alter database add standby logfile
   group 10 ('/u01/app/oracle/oradata/PROD/stby_redo10.log') SIZE 100M,
   group 11 ('/u01/app/oracle/oradata/PROD/stby_redo11.log') SIZE 100M,
   group 12 ('/u01/app/oracle/oradata/PROD/stby_redo12.log') SIZE 100M,
   group 13 ('/u01/app/oracle/oradata/PROD/stby_redo13.log') SIZE 100M,
   group 14 ('/u01/app/oracle/oradata/PROD/stby_redo14.log') SIZE 100M,
   group 15 ('/u01/app/oracle/oradata/PROD/stby_redo15.log') SIZE 100M;
```

**Standby db에 똑같이 생성**

```sql
export ORACLE_SID=SBDB

sqlplus / as sysdba

create spfile from pfile;

startup mount

alter database add standby logfile
   group 10 ('/u01/app/oracle/oradata/SBDB/stby_redo10.log') SIZE 100M,
   group 11 ('/u01/app/oracle/oradata/SBDB/stby_redo11.log') SIZE 100M,
   group 12 ('/u01/app/oracle/oradata/SBDB/stby_redo12.log') SIZE 100M,
   group 13 ('/u01/app/oracle/oradata/SBDB/stby_redo13.log') SIZE 100M,
   group 14 ('/u01/app/oracle/oradata/SBDB/stby_redo14.log') SIZE 100M,
   group 15 ('/u01/app/oracle/oradata/SBDB/stby_redo15.log') SIZE 100M; 
```

**Standby 복구모드 변환**

Primary db에서 오는 redo log를 Standby에 계속 적용하게 한다

disconnect 옵션을 사용해 세션을 종료해도 백그라운드 프로세스로 돌려 복구를 진행한다

```sql
alter database flashback on;

# 복구모드 변환
recover managed standby database disconnect;

# MRP(Media Recovery Process) 가 떠있는지 확인
select process, status from v$managed_standby;
PROCESS   STATUS
--------- ------------
ARCH      CONNECTED
DGRD      ALLOCATED
DGRD      ALLOCATED
ARCH      CONNECTED
ARCH      CONNECTED
ARCH      CONNECTED
**MRP0      WAIT_FOR_LOG**
DGRD      ALLOCATED
```

**Primary, Standby 각각 데이터파일 수 확인**

```sql
# primary, standby 각각 데이터파일 수 확인
select name from v$datafile;

export ORACLE_SID=PROD

sqlplus / as sysdba

select status from v$instance;

STATUS
------------
MOUNTED

alter database open;

# role 확인
select open_mode, database_role 
from   v$database;

OPEN_MODE            DATABASE_ROLE
-------------------- ----------------
READ WRITE           PRIMARY
```

**검증**

Primary에서 테이블스페이스 생성 시 Standby에도 생성 확인

```sql
create tablespace ts9000
   datafile '/u01/app/oracle/oradata/PROD/disk2/ts9000.dbf' size 10m;
   
# 로그 스위치 발생
alter system switch logfile;
alter system switch logfile;
alter system checkpoint;

# Primary, Standby 각각 데이터파일 수 확인
select name from v$datafile;
```

**내리는 순서**

```sql
#1. Standby 복구모드 취소
alter database recover managed standby database cancel;
#2. Standby 즉시 종료
#3. Primary 즉시 종료 
#4. Listener 종료
```