# Primary Server Setup (spfile)

### Logging

**primary db가 archive mode인지 확인**

```sql
select log_mode from v$database;

LOG_MODE
------------
NOARCHIVELOG
```

**noarchivelog mode일 때** 

```sql
shutdown immediate
startup mount

alter database archivelog;
alter database open;

# 로그 스위치를 발생해 아카이브 로그 생성 확인
alter system switch logfile;

select name from v$archived_log;

NAME
--------------------------------------------------------------------------------
/u01/app/oracle/product/19.3.0/dbhome_1/dbs/arch1_15_1214763347.dbf
```

**Force Logging 활성화**

```sql
alter database force logging;

alter database add supplemental log data
   (primary key, unique index) columns;
   
# force logging 활성화
select force_logging from v$database;

FORCE_LOGGING
---------------------------------------
YES
```

### 파라미터 설정

**DB_NAME, DB_UNIQUE_NAME 파라미터 확인**

```bash
show parameter db_name

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_name                              string      PROD

show parameter db_unique_name
NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_unique_name                       string      PROD
```

- DB_NAME : 데이터베이스 이름, Primary와 Standby가 동일해야 한다
- DB_UNIQUE_NAME : RAC나 Data Guard 환경에서 각 데이터베이스의 고유 식별자

**DG_CONFIG=(PROD,SBDB)** 

- DG_CONFIG : Data Guard 구성에 참여하는 모든 데이터베이스(DB_UNIQUE_NAME) 나열
- Primary, Standby 모두 Data Guard 구성에 참여함을 지정
- 아카이브 로그가 전송, 적용될 수 있도록 한다
    
    ```sql
    alter system set log_archive_config='DG_CONFIG=(PROD,SBDB)';
    ```
    

**LOG_ARCHIVE_DEST_2**

- Primary에서 생성된 로그를 Standby로 전송하기 위한 목적지
    
    ```sql
    alter system set log_archive_dest_2='service=SBDB LGWR SYNC AFFIRM valid_for=(online_logfiles,primary_role) db_unique_name=SBDB';
    ```
    

**LOG_ARCHIVE_DEST_STATE_2=ENABLE**

- 해당 목적지 활성화
    
    ```sql
    alter system set log_archive_dest_state_2=ENABLE;
    ```
    

**LOG_ARCHIVE_FORMAT='%t_%s_%r.arc’**

- 아카이브 로그 파일 이름 형식 지정
    - `%t`: Thread 번호
    - `%s`: 시퀀스 번호
    - `%r`: Resetlogs 번호
    
    ```sql
    alter system set log_archive_format='%t_%s_%r.arc' scope=spfile;
    ```
    

**LOG_ARCHIVE_MAX_PROCESSES=300**

- 동시에 아카이브 로그를 생성/전송할 수 있는 최대 프로세스 수
    
    ```sql
    alter system set log_archive_max_processes=300;
    ```
    

**REMOTE_LOGIN_PASSWORDFILE=EXCLUSIVE**

- Remote Login 시 password file 사용 방식
    
    ```sql
    alter system set remote_login_passwordfile=exclusive scope=spfile;
    ```
    

**Primary, Standby 전환 설정**

```sql
alter system set fal_server=SBDB;
alter system set db_file_convert='SBDB','PROD' scope=spfile;
alter system set log_file_convert='SBDB','PROD' scope=spfile;
alter system set standby_file_management=auto;
```

### Service Setup

primary, standby db의 엔트리가 각각의 tnsnames.ora 파일에 작성되어야 한다.

이 단계에서는 primary db의 tnsnames.ora 파일만 수정한다

```bash
cd $ORACLE_HOME/network/admin
vi tnsnames.ora

------------------------------------------------------------------------
PROD =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.13.198)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = PROD)
    )
  )

SBDB =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.13.199)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = SBDB)
    )
  )
```

### standby pfile 생성

**standby db manual setup을 위한 파라미터 파일을 생성한다**

duplicate 방식에서는 생성할 필요 없다.

```sql
create pfile='/tmp/initSBDB.ora' from spfile;
```

생성한 primary의 pfile을 열어 standby 구성으로 수정한다

```sql
vi /tmp/initSBDB.ora

*.db_unique_name='SBDB'
*.fal_server='PROD'
*.log_archive_dest_2='SERVICE=db11g ASYNC VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=DB11G'
db_file_name_convert='/u01/app/oracle/oradata/PROD','/u01/app/oracle/oradata/SBDB'
log_file_name_convert='/u01/app/oracle/oradata/PROD','/u01/app/oracle/oradata/SBDB'
```