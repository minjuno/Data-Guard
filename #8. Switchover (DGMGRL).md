# Switchover (DGMGRL)

### **리스너 설정**

**Primary / Standby 각 서버의 listener.ora / tnsnames.ora를 아래와 같이 설정 후 재시작한다**

데이터베이스가 다운되어 서비스에 등록되어 있지 않은 상태에서도 접속이 가능해야 하기 때문에 SERVICE_NAME보다 SID를 사용한다

**listener.ora**

```sql
# Primary
LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.13.198)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )
SID_LIST_LISTENER=
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = PROD_DGMGRL)
      (ORACLE_HOME=/u01/app/oracle/product/19.3.0/dbhome_1)
      (SID_NAME=PROD)
     )
     (SID_DESC =
      (GLOBAL_DBNAME = PROD)
      (ORACLE_HOME = /u01/app/oracle/product/19.3.0/dbhome_1)
      (SID_NAME = PROD)
    )
   )
   
# Standby
LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.13.199)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )
SID_LIST_LISTENER=
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = SBDB_DGMGRL)
      (ORACLE_HOME=/u01/app/oracle/product/19.3.0/dbhome_1)
      (SID_NAME=SBDB)
     )
     (SID_DESC =
      (GLOBAL_DBNAME = SBDB)
      (ORACLE_HOME = /u01/app/oracle/product/19.3.0/dbhome_1)
      (SID_NAME = SBDB)
    )
   )
```

**tnsnames.ora**

```sql
# primary, standby 둘 다 설정

PROD =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.0.113)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SID = PROD)
    )
  )

SBDB =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.0.114)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SID = SBDB)
    )
  )

```

### **Broker 활성화**

각 서버에서 db_broker를 활성화한다

```sql
alter system set dg_broker_start=true scope=both;
```

### Configuration 생성

**Primary 서버에서 Configuration을 생성한다(Primary 등록)**

```sql
$ dgmgrl sys/oracle@PROD
DGMGRL for Linux: Release 19.0.0.0.0 - Production on Thu Oct 23 19:14:26 2025
Version 19.3.0.0.0

Copyright (c) 1982, 2019, Oracle and/or its affiliates.  All rights reserved.

Welcome to DGMGRL, type "help" for information.
Connected to "PROD"
Connected as SYSDBA.

DGMGRL> create configuration juno_dg_config as primary database is PROD connect identifier is PROD;
Configuration "juno_dg_config" created with primary database "prod"
```

**Standby database 추가**

```sql
DGMGRL> add database SBDB as connect identifier is SBDB;
Database "sbdb" added
```

**Configuration 활성화**

```sql
DGMGRL> enable configuration;
Enabled.
```

### Configuration 상태 확인

```sql
DGMGRL> show configuration;

Configuration - juno_dg_config

  Protection Mode: MaxPerformance
  Members:
  prod - Primary database
    sbdb - Physical standby database

Fast-Start Failover:  Disabled

Configuration Status:
SUCCESS   (status updated 34 seconds ago)

-----------------------------------------------

DGMGRL> show database PROD;

Database - prod

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    PROD

Database Status:
SUCCESS

-----------------------------------------------

DGMGRL> show database SBDB;

Database - sbdb

  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      0 seconds (computed 0 seconds ago)
  Apply Lag:          0 seconds (computed 0 seconds ago)
  Average Apply Rate: 1.00 KByte/s
  Real Time Query:    OFF
  Instance(s):
    SBDB

Database Status:
SUCCESS
```

### Switchover 테스트

**switchover 가능 여부 확인**

```sql
DGMGRL> validate database PROD;

  Database Role:    Primary database

  **Ready for Switchover:  Yes**
  
-----------------------------------------------

DGMGRL> validate database SBDB;

  Database Role:     Physical standby database
  Primary Database:  prod

  **Ready for Switchover:  Yes**
  Ready for Failover:    Yes (Primary Running)
```

**PROD(Primary) → Standby switchover**

```sql
dgmgrl sys/oracle@PROD

DGMGRL> switchover to SBDB;

Performing switchover NOW, please wait...
Operation requires a connection to database "sbdb"
Connecting ...
Connected to "SBDB"
Connected as SYSDBA.
New primary database "sbdb" is opening...
Operation requires start up of instance "PROD" on database "prod"
Starting instance "PROD"...
Connected to an idle instance.
ORACLE instance started.
Connected to "PROD"
Database mounted.
Connected to "PROD"
Switchover succeeded, new primary is "sbdb"
```

**switchover 후 상태 확인**

```sql
DGMGRL> show configuration;

Configuration - juno_dg_config

  Protection Mode: MaxPerformance
  Members:
  sbdb - Primary database
    prod - Physical standby database

Fast-Start Failover:  Disabled

Configuration Status:
SUCCESS   (status updated 12 seconds ago)

-----------------------------------------------

DGMGRL> show database PROD;

Database - prod

  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      0 seconds (computed 1 second ago)
  Apply Lag:          0 seconds (computed 1 second ago)
  Average Apply Rate: 89.00 KByte/s
  Real Time Query:    OFF
  Instance(s):
    PROD

Database Status:
SUCCESS

-----------------------------------------------

DGMGRL> show database SBDB;

Database - sbdb

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    SBDB

Database Status:
SUCCESS
```

### Switchback 테스트

**SBDB(Primary) → Standby**

```sql
dgmgrl sys/oracle@SBDB

show database PROD;
show database SBDB;

validate database PROD;
validate database SBDB;

DGMGRL> switchover to PROD;
```